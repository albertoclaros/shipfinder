<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mi Flota en Tiempo Real</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }

  /* Barra inferior */
  .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: #000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
    box-sizing: border-box;
    z-index: 1000;
  }
  .bottom-bar button, .bottom-bar input {
    color: #fff;
    background: none;
    border: none;
    font-size: 18px;
    outline: none;
  }
  .bottom-bar input {
    flex: 1;
    margin-left: 10px;
    padding: 5px 10px;
    border-radius: 5px;
    background-color: #222;
    color: #fff;
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- Barra inferior -->
<div class="bottom-bar">
  <button onclick="toggleFlotaFilter()">üö¢ Mis Flotas</button>
  <input type="text" id="buscador" placeholder="Buscar buque..." oninput="buscarBarco()">
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const API_KEY = "4ee9dacb9c0126f73eeafa902bdecb146397ac9f";

  // Crear mapa
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Icono barco
  const barcoIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/77/77104.png',
    iconSize: [28, 28],
    iconAnchor: [14, 14],
    popupAnchor: [0, -14]
  });

  // Diccionarios
  const barcos = {};     // todos los barcos visibles {MMSI: marcador}
  const barcosData = {}; // datos de barcos {MMSI: {nombre, mmsi}}
  const misFlotas = {};  // {flotaNombre: [MMSI,...]}
  let mostrarSoloFlotas = false;

  // Conectar WebSocket AISStream
  const socket = new WebSocket("wss://stream.aisstream.io/v0/stream?apikey=" + API_KEY);

  socket.onopen = () => {
    console.log("‚úÖ Conectado a AISStream.io");
    // Suscripci√≥n a todo el mundo
    const subscription = {
      Apikey: API_KEY,
      BoundingBoxes: [[[-90, -180],[90,180]]],
      FiltersShipMMSI: []
    };
    socket.send(JSON.stringify(subscription));
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.MessageType === "PositionReport") {
      const mmsi = data.MetaData?.MMSI;
      const lat = data.Message?.Latitude;
      const lon = data.Message?.Longitude;
      const nombre = data.MetaData?.ShipName || "Barco " + mmsi;

      if (!mmsi || !lat || !lon) return;

      barcosData[mmsi] = {nombre, mmsi};

      if (barcos[mmsi]) {
        barcos[mmsi].setLatLng([lat, lon]);
      } else {
        barcos[mmsi] = L.marker([lat, lon], {icon: barcoIcon})
          .addTo(map)
          .bindPopup(`<b>${nombre}</b><br>MMSI: ${mmsi}`)
          .on('click', () => agregarABarcoFlota(mmsi));
      }

      aplicarFiltroFlotas();
    }
  };

  socket.onerror = (err) => console.error("‚ùå Error AISStream:", err);

  // Funciones de flotas
  function agregarABarcoFlota(mmsi) {
    const nombreFlota = prompt("Nombre de la flota donde agregar este barco:");
    if (!nombreFlota) return;
    if (!misFlotas[nombreFlota]) misFlotas[nombreFlota] = [];
    if (!misFlotas[nombreFlota].includes(mmsi)) misFlotas[nombreFlota].push(mmsi);
    alert(`Barco agregado a ${nombreFlota}`);
  }

  function toggleFlotaFilter() {
    mostrarSoloFlotas = !mostrarSoloFlotas;
    aplicarFiltroFlotas();
  }

  function aplicarFiltroFlotas() {
    for (let mmsi in barcos) {
      const marker = barcos[mmsi];
      if (!mostrarSoloFlotas) {
        marker.addTo(map);
      } else {
        let enFlota = false;
        for (let f in misFlotas) {
          if (misFlotas[f].includes(mmsi)) enFlota = true;
        }
        if (enFlota) marker.addTo(map);
        else map.removeLayer(marker);
      }
    }
  }

  function buscarBarco() {
    const query = document.getElementById('buscador').value.toLowerCase();
    for (let mmsi in barcos) {
      const marker = barcos[mmsi];
      const nombre = barcosData[mmsi].nombre.toLowerCase();
      if (nombre.includes(query) || mmsi.includes(query)) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    }
  }
</script>
</body>
</html>
